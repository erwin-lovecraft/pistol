<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Room {{.RoomID}} - SSE Viewer</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" content="Pistol: lightweight room message viewer & push. SSE real-time observability with zero fluff." />
    <meta name="theme-color" content="#f5f5f7" />

    <!-- Open Graph / social preview -->
    <meta property="og:title" content="Pistol â€” Minimalist Room Message Viewer" />
    <meta property="og:description" content="Watch room messages in real-time via SSE and push new messages. Zero UI friction." />
    <meta property="og:type" content="website" />
    
    <link rel="icon" href="/static/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Pistol" />
    <meta name="application-name" content="Pistol" />
    <link rel="manifest" href="/static/site.webmanifest" />

    <script src="https://unpkg.com/htmx.org@1.9.3"></script>
    <style>
        :root {
            --bg: #f2f2f7;
            --panel-bg: #ffffff;
            --muted: #6e6e73;
            --radius: 14px;
            --shadow: 0 20px 40px -10px rgba(0,0,0,0.1);
            --border: 1px solid rgba(60,60,67,0.18);
            --focus-ring: 2px solid rgba(0,122,255,0.6);
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        * { box-sizing:border-box; }
        body { background: var(--bg); margin:0; display:flex; height:100vh; color:#1c1c1e; }
        #sidebar { width: 320px; padding:16px; background: rgba(255,255,255,0.85); backdrop-filter: blur(18px); border-right: var(--border); overflow:auto; display:flex; flex-direction:column; }
        #detail { flex:1; padding:24px; overflow:auto; }
        h3 { margin:0 0 12px; font-weight:600; font-size:1.25rem; }
        h4 { margin-top:0; font-weight:600; }
        .message { position:relative; padding:12px 14px; margin-bottom:8px; background: var(--panel-bg); border-radius:12px; cursor:pointer; transition: background .2s ease, transform .1s ease; display:flex; flex-direction:column; box-shadow: 0 8px 24px rgba(0,0,0,0.04); }
        .message:hover { background: #f7f7fa; }
        .message.active { outline: none; border: 2px solid rgba(0,122,255,0.5); }
        .message small { color: var(--muted); }
        .pre { background: #f5f5f7; padding:12px; border-radius:8px; overflow:auto; font-family: Menlo, monospace; font-size:0.9rem; line-height:1.3; }
        .kv-table { width:100%; border-collapse: collapse; font-size:0.7rem; margin-top:4px; }
        .kv-key { text-align:left; padding:4px 8px; font-weight:600; vertical-align:top; color:#3c3c44; width:30%; }
        .kv-value { padding:4px 8px; }
        .kv-table tr + tr { border-top:1px solid rgba(60,60,67,0.08); }
        .card { background: var(--panel-bg); border-radius:16px; padding:16px; box-shadow: var(--shadow); }
        .meta { font-size:0.75rem; color: var(--muted); }
        .divider { height:1px; background: rgba(60,60,67,0.08); margin:16px 0; }
        button { background: #007aff; border:none; color:white; padding:10px 16px; border-radius:12px; font-weight:600; cursor:pointer; transition:filter .2s; }
        button:focus { outline: none; box-shadow: 0 0 0 3px rgba(0,122,255,0.35); }
        button:hover { filter:brightness(1.05); }
    </style>
</head>
<body>
<div id="sidebar">
    <h3 style="margin:8px">Room {{.RoomID}}</h3>
    <div id="messages"></div>
    <div id="load-more-sentinel" style="height:1px;"></div>
</div>
<div id="detail">
    <h4>Message detail</h4>
    <div id="detail-content">(click message to view)</div>
</div>

<script>
    const roomID = encodeURIComponent("{{.RoomID}}");
    const evtSource = new EventSource(`/api/v1/rooms/${roomID}/events`);
    const messagesDiv = document.getElementById('messages');
    const detailDiv = document.getElementById('detail-content');
    const sentinel = document.getElementById('load-more-sentinel');

    let currentPage = 1;
    const pageSize = 50;
    let isLoading = false;
    let noMore = false;
    const seenIds = new Set(); // dedupe

    function renderKVTable(obj) {
        if (!obj || Object.keys(obj).length === 0) {
            return '<div style="font-size:0.75rem; color: var(--muted)">(none)</div>';
        }
        let html = '<table class="kv-table" aria-label="key value table"><tbody>';
        for (const key of Object.keys(obj)) {
            let val = obj[key];
            if (Array.isArray(val)) {
                val = val.join(', ');
            }
            const safeKey = key.replace(/</g, '&lt;');
            const safeVal = String(val).replace(/</g, '&lt;');
            html += `<tr><th class="kv-key">${safeKey}</th><td class="kv-value">${safeVal}</td></tr>`;
        }
        html += '</tbody></table>';
        return html;
    }

    function makeSidebarItem(msg, prepend = false) {
        if (seenIds.has(msg.id)) return null; // skip duplicate
        seenIds.add(msg.id);

        const el = document.createElement('div');
        el.className = 'message';
        el.dataset.id = msg.id;
        el.innerHTML = `<div><strong>${msg.method}</strong> <small>${msg.id}</small></div>`;
        el.addEventListener('click', () => {
            document.querySelectorAll('.message').forEach(m => m.classList.remove('active'));
            el.classList.add('active');
            const headersHTML = renderKVTable(msg.header);
            const queryParamsHTML = renderKVTable(msg.query_params);
            detailDiv.innerHTML = `<div style="margin-bottom:6px;"><strong style="font-size:0.9rem;">Method:</strong> <span style="font-size:0.85rem;">${msg.method}</span></div>` +
                `<div style="margin-top:8px"><strong style="font-size:0.9rem;">Headers:</strong>${headersHTML}</div>` +
                `<div style="margin-top:8px"><strong style="font-size:0.9rem;">Query params:</strong>${queryParamsHTML}</div>` +
                `<div style="margin-top:8px"><strong style="font-size:0.9rem;">Body:</strong><pre class='pre' style="font-size:0.75rem;">${JSON.stringify(msg.body, null, 2)}</pre></div>`;
        });
        if (prepend) {
            messagesDiv.prepend(el);
        } else {
            messagesDiv.appendChild(el);
        }
        return el;
    }

    evtSource.onmessage = function(e) {
        try {
            const data = JSON.parse(e.data);
            makeSidebarItem(data, true); // real-time newest on top
        } catch (err) {
            console.warn('failed parse', err, e.data);
        }
    };

    evtSource.onerror = function(e) { console.error('SSE error', e); };

    async function fetchMessages(page, size) {
        const resp = await fetch(`/api/v1/rooms/${roomID}?` + new URLSearchParams({
            page: page,
            size: size,
        }));
        if (!resp.ok) {
            throw new Error(`status ${resp.status}`);
        }
        const body = await resp.json();
        if (!body || !Array.isArray(body.data)) {
            throw new Error('unexpected payload shape');
        }
        return body.data;
    }

    async function loadOlder() {
        if (isLoading || noMore) return;
        isLoading = true;
        try {
            currentPage += 1;
            const older = await fetchMessages(currentPage, pageSize);
            if (!older.length) {
                noMore = true;
                return;
            }
            // assume older messages are chronologically before those already loaded,
            // so append at bottom.
            for (const msg of older) {
                if (!msg) continue;
                makeSidebarItem(msg, false);
            }
            // if returned less than requested, we likely exhausted.
            if (older.length < pageSize) {
                noMore = true;
            }
        } catch (err) {
            console.warn('failed loading older messages', err);
            currentPage -= 1; // rollback page on failure
        } finally {
            isLoading = false;
        }
    }

    // initial load
    (async () => {
        try {
            const initial = await fetchMessages(currentPage, pageSize);
            for (const msg of initial) {
                if (!msg) continue;
                makeSidebarItem(msg, false);
            }
            if (initial.length < pageSize) noMore = true;
        } catch (err) {
            console.error('error fetching initial messages', err);
        }
    })();

    // intersection observer for infinite scroll (when sentinel comes into view -> load older)
    const observer = new IntersectionObserver(entries => {
        for (const entry of entries) {
            if (entry.isIntersecting) {
                loadOlder();
            }
        }
    }, {
        root: document.getElementById('sidebar'),
        rootMargin: '0px',
        threshold: 1.0,
    });
    observer.observe(sentinel);

</script>
</body>
</html>
